<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ABS Crackers — Admin (Updated)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg: #0f172a;
        --card: #111827;
        --muted: #9ca3af;
        --text: #e5e7eb;
        --brand: #60a5fa;
        --ok: #22c55e;
        --border: #1f2937;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        background: var(--bg);
        color: var(--text);
      }
      .wrap {
        max-width: 1200px;
        margin: 32px auto;
        padding: 0 16px;
      }
      h1 {
        font-size: 28px;
        margin: 0 0 16px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
      }
      .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .badge {
        background: #0b1220;
        border: 1px solid var(--border);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
      }
      input.search {
        width: 420px;
        max-width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        background: #0b1220;
        border: 1px solid var(--border);
        color: var(--text);
      }
      button {
        cursor: pointer;
        border: none;
      }
      .btn {
        padding: 8px 12px;
        border-radius: 10px;
        background: #0b1220;
        border: 1px solid var(--border);
        color: var(--text);
      }
      .btn:hover {
        border-color: #2b3647;
      }
      .btn-primary {
        background: var(--brand);
        color: #00122a;
        border-color: transparent;
      }
      .btn-danger {
        background: #ef4444;
        color: white;
      }
      .btn-xs {
        padding: 6px 8px;
        font-size: 12px;
        border-radius: 8px;
      }
      .view-toggle {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .view-toggle button {
        padding: 6px 10px;
        border-radius: 8px;
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
      }
      .view-toggle button.active {
        background: var(--brand);
        color: #00122a;
        border-color: transparent;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        border-spacing: 0;
      }
      th,
      td {
        padding: 12px;
        border-top: 1px solid var(--border);
        text-align: left;
        font-size: 14px;
      }
      th {
        font-weight: 600;
        color: #cbd5e1;
        background: #0b1220;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      tr:hover td {
        background: #0b1220;
      }

      .status-badges {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 6px;
      }
      .sbadge {
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        background: #0b1220;
        border: 1px solid var(--border);
      }
      .sbadge.paid {
        background: #fef3c7;
        color: #92400e;
        border-color: transparent;
      }
      .sbadge.packing {
        background: #fff7ed;
        color: #92400e;
        border-color: transparent;
      }
      .sbadge.packed {
        background: #bbf7d0;
        color: #064e3b;
        border-color: transparent;
      }
      .sbadge.delivered {
        background: #dbeafe;
        color: #1e3a8a;
        border-color: transparent;
      }

      /* ---- Invoice preview modal ---- */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 1000; /* 👈 higher than table headers */
      }
      .modal.show {
        display: flex;
      }
      .modal-card {
        width: min(780px, 100%);
        max-height: 90vh;
        overflow: auto;
        background: #fff;
        color: #111;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45);
        z-index: 1001; /* 👈 above backdrop */
        position: relative;
      }

      .modal-head {
        padding: 14px 18px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .modal-head h3 {
        margin: 0;
        font-size: 18px;
      }
      .modal-body {
        padding: 18px;
      }
      .invoice {
        font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
      }
      .inv-row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }
      .inv-col {
        flex: 1 1 260px;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 12px;
      }
      .inv-k {
        color: #64748b;
        font-size: 12px;
      }
      .inv-v {
        font-weight: 600;
      }
      .inv-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
      }
      .inv-table th,
      .inv-table td {
        border: 1px solid #e5e7eb;
        padding: 8px 10px;
        font-size: 13px;
      }
      .inv-total {
        display: flex;
        justify-content: flex-end;
        margin-top: 12px;
        font-size: 16px;
        font-weight: 700;
      }
      .close-x {
        background: transparent;
        font-size: 22px;
        line-height: 1;
      }

      /* package inputs */
      .packed-qty-input {
        width: 72px;
        padding: 6px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #0b1220;
        color: var(--text);
      }
      .package-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }

      /* --- Mobile Friendly Tweaks --- */
      @media (max-width: 768px) {
        h1 {
          font-size: 20px;
          margin-bottom: 12px;
        }

        .toolbar {
          flex-direction: column;
          align-items: stretch;
          gap: 10px;
        }

        input.search {
          width: 100%;
          font-size: 14px;
        }

        table {
          font-size: 12px;
        }

        th,
        td {
          padding: 8px;
        }

        .btn,
        .btn-xs {
          font-size: 12px;
          padding: 6px 8px;
        }

        /* Table wrapper for horizontal scroll */
        .card > div {
          overflow-x: auto;
        }

        /* Actions buttons stack on mobile */
        td:last-child {
          display: flex;
          flex-wrap: wrap;
          gap: 6px;
        }
      }

      @media (max-width: 480px) {
        h1 {
          font-size: 18px;
        }
        .inv-col {
          flex: 1 1 100%;
        }
        .modal-card {
          width: 95%;
        }
      }
      /* Prevent dark hover inside invoice modal */
      .inv-table tr:hover td {
        background: #f1f5f9; /* light gray, matches invoice background */
      }
      /* Fix hover visibility inside consolidation view */
      #consolidationPanel table tr:hover td {
        background: #1e293b; /* slate-800 style, lighter than card */
        color: #e5e7eb; /* keep text visible */
        cursor: pointer;
      }
      #consolidationPanel table tr#details-* td {
        background: #0b1220 !important; /* keep expanded details dark */
      }
    </style>

    <!-- NEW: jsPDF + AutoTable for invoice PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>
  </head>
  <body>
    <div
      id="loginBox"
      class="card"
      style="max-width: 400px; margin: 0 auto 20px; display: none"
    >
      <h2 style="margin-bottom: 12px; font-size: 18px">Admin Login</h2>
      <input
        id="emailInput"
        type="email"
        placeholder="Email"
        style="
          width: 100%;
          padding: 10px;
          margin-bottom: 10px;
          border-radius: 8px;
          border: 1px solid #ccc;
        "
      />
      <input
        id="passwordInput"
        type="password"
        placeholder="Password"
        style="
          width: 100%;
          padding: 10px;
          margin-bottom: 10px;
          border-radius: 8px;
          border: 1px solid #ccc;
        "
      />
      <button id="loginBtn" class="btn btn-primary" style="width: 100%">
        Sign In
      </button>
      <div id="loginError" style="color: red; display: none; margin-top: 8px">
        Invalid email or password
      </div>
    </div>

    <div class="wrap">
      <h1>ABS Crackers – Admin</h1>
      <div style="margin-bottom: 16px; text-align: right">
        <a
          href="https://abscrackersworld-product-admin.vercel.app/"
          target="_blank"
          class="btn btn-primary"
        >
          Product Admin
        </a>
      </div>

      <div id="ordersPanel" class="card">
        <div class="toolbar">
          <div
            style="
              display: flex;
              gap: 8px;
              align-items: center;
              flex-wrap: wrap;
            "
          >
            <span id="userEmail" class="badge">Not signed in</span>
            <span id="orderCount" class="badge">0 orders</span>
          </div>
          <div style="display: flex; gap: 8px; align-items: center">
            <div class="view-toggle" role="tablist" aria-label="Views">
              <button id="viewAll" class="active">All Orders</button>
              <button id="viewConfirmed">Confirmed</button>
              <button id="viewDelivered">Delivered</button>
            </div>
            <!-- Consolidation Toggle (only visible in Confirmed view) -->
            <div
              id="confirmedViewToggle"
              style="margin: 10px 0; display: none; gap: 8px"
            >
              <button id="showConfirmedOrders" class="btn btn-xs btn-primary">
                View Orders
              </button>
              <button id="showConsolidation" class="btn btn-xs">
                View Consolidation
              </button>
            </div>

            <!-- Consolidation Panel -->
            <div id="consolidationPanel" style="display: none"></div>

            <input
              class="search"
              id="searchInput"
              placeholder="Search name / phone / address…"
            />
            <button id="authBtn" class="btn-primary btn">Sign in</button>
          </div>
        </div>

        <div style="overflow: auto; border-radius: 10px">
          <table id="ordersTable">
            <thead>
              <tr>
                <th>Customer</th>
                <th>Amount</th>
                <th>Date-Time</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody id="ordersTbody">
              <tr>
                <td colspan="7" style="text-align: center; color: var(--muted)">
                  Please sign in
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- NEW: Invoice Preview Modal -->
    <div id="invoiceModal" class="modal" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-head">
          <h3>Invoice Preview</h3>
          <div style="display: flex; gap: 8px">
            <button id="downloadPdfBtn" class="btn btn-primary btn-xs">
              Download PDF
            </button>
            <button id="closeModalBtn" class="close-x" title="Close">✕</button>
          </div>
        </div>
        <div class="modal-body">
          <div id="invoicePreview" class="invoice"></div>
        </div>
      </div>
    </div>

    <!-- PACKAGE CHECKLIST MODAL -->
    <div id="packageModal" class="modal" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-head">
          <h3>Package Checklist</h3>
          <div style="display: flex; gap: 8px; align-items: center">
            <button id="closePackageModalBtn" class="close-x" title="Close">
              ✕
            </button>
          </div>
        </div>
        <div class="modal-body">
          <div id="packageChecklist"></div>
        </div>
      </div>
    </div>

    <script type="module">
      // ---------- Firebase ----------
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

      import {
        getFirestore,
        collection,
        query,
        orderBy,
        onSnapshot,
        doc,
        getDoc,
        deleteDoc,
        updateDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyC47paJy6jtyR6IH8Wq1wddeEXxS26zQeU",
        authDomain: "abscrackersworld-5e2e8.firebaseapp.com",
        projectId: "abscrackersworld-5e2e8",
        storageBucket: "abscrackersworld-5e2e8.appspot.com",
        messagingSenderId: "1045745449432",
        appId: "1:1045745449432:web:c807324227ec41afb85aad",
        measurementId: "G-Q6G22EPHS5",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // ---------- DOM refs ----------
      const authBtn = document.querySelector("#authBtn");
      const userEmailEl = document.querySelector("#userEmail");
      const orderCountEl = document.querySelector("#orderCount");
      const tbody = document.querySelector("#ordersTbody");
      const searchInput = document.querySelector("#searchInput");

      const viewAllBtn = document.querySelector("#viewAll");
      const viewConfirmedBtn = document.querySelector("#viewConfirmed");
      const viewDeliveredBtn = document.querySelector("#viewDelivered");

      // modal refs
      const modal = document.querySelector("#invoiceModal");
      const closeModal = document.querySelector("#closeModalBtn");
      const downloadBtn = document.querySelector("#downloadPdfBtn");
      const previewEl = document.querySelector("#invoicePreview");

      // package modal refs
      const packageModal = document.querySelector("#packageModal");
      const packageChecklistEl = document.querySelector("#packageChecklist");
      const closePackageModalBtn = document.querySelector(
        "#closePackageModalBtn"
      );

      // ---------- DOM refs for login ----------
      const loginBox = document.querySelector("#loginBox");
      const loginBtn = document.querySelector("#loginBtn");
      const loginError = document.querySelector("#loginError");
      const ordersPanel = document.querySelector("#ordersPanel");

      // Initially: show login, hide orders
      ordersPanel.style.display = "none";
      loginBox.style.display = "block";

      // Handle login button click
      loginBtn.addEventListener("click", async () => {
        const email = document.querySelector("#emailInput").value.trim();
        const pass = document.querySelector("#passwordInput").value.trim();

        try {
          await signInWithEmailAndPassword(auth, email, pass);
          loginError.style.display = "none";
        } catch (err) {
          console.error("Login error:", err.message);
          loginError.style.display = "block";
        }
      });

      // ✅ Single Auth state listener
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // Logged in
          loginBox.style.display = "none";
          ordersPanel.style.display = "block";
          userEmailEl.textContent = user.email || "Signed in";
          authBtn.textContent = "Sign out";
          startOrdersListener();
        } else {
          // Logged out
          loginBox.style.display = "block";
          ordersPanel.style.display = "none";
          userEmailEl.textContent = "Not signed in";
          authBtn.textContent = "Sign in";
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:var(--muted)">Please sign in</td></tr>`;
        }
      });

      authBtn.addEventListener("click", async () => {
        if (auth.currentUser) {
          await signOut(auth);
        } else {
          // show login box (already visible when signed out)
          loginBox.style.display = "block";
        }
      });

      let ORDERS = []; // cached snapshot for search
      let CURRENT_ORDER_ID = null;
      let CURRENT_ORDER = null;
      let ACTIVE_VIEW = "all"; // all | confirmed | delivered
      let CONFIRMED_MODE = "orders"; // "orders" | "consolidation"

      document
        .querySelector("#showConfirmedOrders")
        .addEventListener("click", () => {
          CONFIRMED_MODE = "orders";
          document
            .querySelector("#showConfirmedOrders")
            .classList.add("btn-primary");
          document
            .querySelector("#showConsolidation")
            .classList.remove("btn-primary");
          document.querySelector("#consolidationPanel").style.display = "none";
          document.querySelector("#ordersTable").style.display = "table";
          renderCurrentView();
        });

      document
        .querySelector("#showConsolidation")
        .addEventListener("click", () => {
          CONFIRMED_MODE = "consolidation";
          document
            .querySelector("#showConsolidation")
            .classList.add("btn-primary");
          document
            .querySelector("#showConfirmedOrders")
            .classList.remove("btn-primary");
          document.querySelector("#ordersTable").style.display = "none";
          document.querySelector("#consolidationPanel").style.display = "block";
          renderCurrentView();
        });

      // ---------- Orders listener ----------
      function startOrdersListener() {
        const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snap) => {
          ORDERS = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
          // ensure backward-compatible fields
          ORDERS = ORDERS.map((o) => ({
            paymentStatus: o.paymentStatus || "pending",
            deliveryStatus:
              o.deliveryStatus ||
              (o.status === "packed" ? "delivered" : "notDelivered"),
            ...o,
          }));
          orderCountEl.textContent = `${ORDERS.length} orders`;
          renderCurrentView();
        });
      }

      // view toggle
      viewAllBtn.addEventListener("click", () => {
        setActiveView("all");
      });
      viewConfirmedBtn.addEventListener("click", () => {
        setActiveView("confirmed");
      });
      viewDeliveredBtn.addEventListener("click", () => {
        setActiveView("delivered");
      });

      // function setActiveView(v) {
      //   ACTIVE_VIEW = v;
      //   [viewAllBtn, viewConfirmedBtn, viewDeliveredBtn].forEach((b) =>
      //     b.classList.remove("active")
      //   );
      //   if (v === "all") viewAllBtn.classList.add("active");
      //   if (v === "confirmed") viewConfirmedBtn.classList.add("active");
      //   if (v === "delivered") viewDeliveredBtn.classList.add("active");
      //   renderCurrentView();
      // }
      function setActiveView(v) {
        ACTIVE_VIEW = v;
        [viewAllBtn, viewConfirmedBtn, viewDeliveredBtn].forEach((b) =>
          b.classList.remove("active")
        );
        if (v === "all") viewAllBtn.classList.add("active");
        if (v === "confirmed") viewConfirmedBtn.classList.add("active");
        if (v === "delivered") viewDeliveredBtn.classList.add("active");

        // show consolidation toggle only in confirmed view
        document.querySelector("#confirmedViewToggle").style.display =
          v === "confirmed" ? "flex" : "none";

        renderCurrentView();
      }

      function renderCurrentView() {
        const terms = (searchInput.value || "").trim().toLowerCase();
        let list = ORDERS.slice();

        // if (ACTIVE_VIEW === "confirmed") {
        //   list = list.filter((o) => (o.paymentStatus || "pending") === "paid");
        // } else if (ACTIVE_VIEW === "delivered") {
        //   list = list.filter(
        //     (o) =>
        //       o.paymentStatus === "paid" &&
        //       (o.status === "packed" || o.deliveryStatus === "delivered")
        //   );
        // }
        if (ACTIVE_VIEW === "confirmed") {
          list = list.filter(
            (o) =>
              (o.paymentStatus || "pending") === "paid" &&
              o.deliveryStatus !== "delivered" &&
              o.status !== "packed" // exclude delivered/packed
          );
        } else if (ACTIVE_VIEW === "delivered") {
          list = list.filter(
            (o) =>
              o.paymentStatus === "paid" &&
              (o.status === "packed" || o.deliveryStatus === "delivered")
          );
        }

        if (CONFIRMED_MODE === "consolidation") {
          renderConsolidation(list);
          return;
        }

        if (terms) {
          list = list.filter((r) =>
            [r.name, r.phone, r.address].join(" ").toLowerCase().includes(terms)
          );
        }

        renderTable(list);
      }

      function renderConsolidation(orders) {
        if (!orders.length) {
          document.querySelector(
            "#consolidationPanel"
          ).innerHTML = `<div style="text-align:center;color:var(--muted)">No confirmed orders</div>`;
          return;
        }

        // Step 1: Aggregate totals
        const productMap = {}; // { itemName: { total: X, customers: [{name, qty}] } }

        orders.forEach((o) => {
          (o.items || []).forEach((it) => {
            const name = it.name || "Unnamed";
            const qty = it.qty || 1;
            if (!productMap[name])
              productMap[name] = { total: 0, customers: [] };
            productMap[name].total += qty;
            productMap[name].customers.push({
              name: o.name || "Customer",
              qty,
            });
          });
        });

        // Step 2: Build table
        let html = `<table class="inv-table">
    <thead>
      <tr><th>Item</th><th style="text-align:right">Total Qty</th></tr>
    </thead>
    <tbody>`;

        Object.entries(productMap).forEach(([name, data], idx) => {
          html += `
      <tr class="expandable" data-key="${idx}">
        <td>▶ ${escapeHtml(name)}</td>
        <td style="text-align:right">${data.total}</td>
      </tr>
      <tr id="details-${idx}" style="display:none;background:#0b1220">
        <td colspan="2">
          ${data.customers
            .map(
              (c) =>
                `<div style="padding:4px 0;border-bottom:1px solid #1f2937">
                   ${escapeHtml(c.name)} → ${c.qty}
                 </div>`
            )
            .join("")}
        </td>
      </tr>`;
        });

        html += `</tbody></table>`;
        document.querySelector("#consolidationPanel").innerHTML = html;

        // Step 3: Toggle expand on click
        document
          .querySelectorAll("#consolidationPanel .expandable")
          .forEach((row) => {
            row.addEventListener("click", () => {
              const key = row.dataset.key;
              const detailRow = document.querySelector(`#details-${key}`);
              if (detailRow.style.display === "none") {
                detailRow.style.display = "table-row";
                row.querySelector("td").textContent = row
                  .querySelector("td")
                  .textContent.replace("▶", "▼");
              } else {
                detailRow.style.display = "none";
                row.querySelector("td").textContent = row
                  .querySelector("td")
                  .textContent.replace("▼", "▶");
              }
            });
          });
      }

      searchInput.addEventListener("input", () => renderCurrentView());

      function renderTable(rows) {
        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:var(--muted)">No orders</td></tr>`;
          return;
        }

        tbody.innerHTML = rows
          .map((o) => {
            const itemCount = (o.items || []).reduce(
              (a, b) => a + (b.qty || 1),
              0
            );
            const amount = o.amount ?? o.total ?? 0;
            const dateObj = o.createdAt?.toDate
              ? o.createdAt.toDate()
              : o.createdAt || new Date();

            const dateStr = new Date(dateObj).toLocaleDateString("en-IN");
            const timeStr = new Date(dateObj).toLocaleTimeString("en-IN");

            const invoiceNo = "INV-" + o.id.slice(0, 6).toUpperCase();
            const msg =
              `🎇 Welcome to ABS Crackers World! 🎇\n\n` +
              `Dear ${o.name || "Customer"}, thank you for choosing us!\n` +
              `🧾 Invoice No: ${invoiceNo}\n\n` +
              `✅ Your order has been successfully received.\n` +
              `Our team will reach out shortly with confirmation & delivery details.\n\n` +
              `Wishing you a safe, bright, and joyful celebration! 🎆✨\n` +
              `- Team ABS Crackers`;

            const waLink = `https://wa.me/91${
              o.phone
            }?text=${encodeURIComponent(msg)}`;

            // Determine badges
            const badges = [];
            if ((o.paymentStatus || "pending") === "paid")
              badges.push('<span class="sbadge paid">Paid 💰</span>');
            if ((o.status || "") === "packing")
              badges.push('<span class="sbadge packing">Packing 🟡</span>');
            if ((o.status || "") === "packed")
              badges.push('<span class="sbadge packed">Packed ✅</span>');
            if (
              (o.paymentStatus || "") === "paid" &&
              (o.status || "") === "packed"
            )
              badges.push('<span class="sbadge delivered">Delivered 📦</span>');

            // action buttons: invoice, package, wa, markPaid, markDelivered, delete
            // const markPaidBtn =
            //   o.paymentStatus === "paid"
            //     ? `<button class="btn btn-xs" disabled>Paid</button>`
            //     : `<button class="btn btn-xs" data-act="markPaid" data-id="${o.id}">Mark Paid</button>`;

            // const markDeliveredBtn =
            //   o.paymentStatus === "paid" &&
            //   (o.status === "packed" || o.deliveryStatus === "delivered")
            //     ? `<button class="btn btn-xs" disabled>Delivered</button>`
            //     : `<button class="btn btn-xs" data-act="markDelivered" data-id="${o.id}">Mark Delivered</button>`;
            // Toggle Paid button
            const markPaidBtn =
              o.paymentStatus === "paid"
                ? `<button class="btn btn-xs" data-act="togglePaid" data-id="${o.id}">Unpaid</button>`
                : `<button class="btn btn-xs" data-act="togglePaid" data-id="${o.id}">Mark Paid</button>`;

            // Toggle Delivered button
            const markDeliveredBtn =
              o.status === "packed" || o.deliveryStatus === "delivered"
                ? `<button class="btn btn-xs" data-act="toggleDelivered" data-id="${o.id}">Undo Delivered</button>`
                : `<button class="btn btn-xs" data-act="toggleDelivered" data-id="${o.id}">Mark Delivered</button>`;

            return `
        <tr data-id="${o.id}">
          <td>
            <div class="name-wrapper">
              <button class="collapse-btn btn btn-xs" style="background:transparent;color:#60a5fa;cursor:pointer;">
                ${escapeHtml(o.name || "")} ▼
              </button>
              <div class="status-badges">${badges.join("")}</div>
              <div class="details" style="display:none;margin-top:6px;font-size:12px;color:#cbd5e1;">
                <div><b>Mobile:</b> ${escapeHtml(o.phone || "")}</div>
                <div><b>Address:</b> ${escapeHtml(o.address || "")}</div>
                <div><b>Items:</b> ${itemCount}</div>
              </div>
            </div>
          </td>
          <td>₹${formatINR(amount)}</td>
          <td>${dateStr} ${timeStr}</td>
          <td>
            <button class="btn btn-xs" data-act="invoice" data-id="${
              o.id
            }">Invoice</button>
            <button class="btn btn-xs" data-act="package" data-id="${
              o.id
            }">Package</button>
            <a href="${waLink}" target="_blank" title="Send WhatsApp Message">
              <img src="https://img.icons8.com/color/24/whatsapp.png" style="vertical-align:middle;cursor:pointer;" />
            </a>
            ${markPaidBtn}
            ${markDeliveredBtn}
            <button class="btn btn-danger btn-xs" data-act="delete" data-id="${
              o.id
            }" title="Delete Order">🗑️</button>
          </td>
        </tr>
      `;
          })
          .join("");
      }

      tbody.addEventListener("click", async (e) => {
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;
        const id = btn.dataset.id;

        if (btn.dataset.act === "invoice") {
          // fetch latest data and open preview
          const snap = await getDoc(doc(db, "orders", id));
          if (!snap.exists()) return;
          CURRENT_ORDER_ID = id;
          CURRENT_ORDER = snap.data();
          openInvoicePreview(id, CURRENT_ORDER);
        }
        if (btn.dataset.act === "package") {
          const snap = await getDoc(doc(db, "orders", id));
          if (!snap.exists()) return;
          CURRENT_ORDER_ID = id;
          CURRENT_ORDER = snap.data();
          openPackageChecklist(id, CURRENT_ORDER);
        }
        if (btn.dataset.act === "delete") {
          if (confirm("Are you sure you want to delete this order?")) {
            await deleteDoc(doc(db, "orders", id));
            alert("Order deleted successfully!");
          }
        }
        // if (btn.dataset.act === "markPaid") {
        //   if (!id) return;
        //   try {
        //     await updateDoc(doc(db, "orders", id), {
        //       paymentStatus: "paid",
        //       updatedAt: serverTimestamp(),
        //     });
        //     alert("Marked as paid ✅");
        //   } catch (err) {
        //     console.error(err);
        //     alert("Failed to mark as paid");
        //   }
        // }
        if (btn.dataset.act === "togglePaid") {
          const snap = await getDoc(doc(db, "orders", id));
          if (!snap.exists()) return;
          const data = snap.data();

          if (data.paymentStatus === "paid") {
            if (
              !confirm(
                "⚠️ Are you sure you want to revert this order to Unpaid?"
              )
            )
              return;
            await updateDoc(doc(db, "orders", id), {
              paymentStatus: "pending",
              updatedAt: serverTimestamp(),
            });
            alert("Reverted to Unpaid ❌");
          } else {
            await updateDoc(doc(db, "orders", id), {
              paymentStatus: "paid",
              updatedAt: serverTimestamp(),
            });
            alert("Marked as Paid ✅");
          }
        }

        // if (btn.dataset.act === "markDelivered") {
        //   if (!id) return;
        //   // mark as delivered only if packed & paid ideally but allow admin to force
        //   try {
        //     const snap = await getDoc(doc(db, "orders", id));
        //     if (!snap.exists()) return;
        //     const data = snap.data();
        //     // set both deliveryStatus and status to packed/delivered if not already
        //     const updates = {
        //       deliveryStatus: "delivered",
        //       updatedAt: serverTimestamp(),
        //     };
        //     // if not packed, also set status to packed (admin forced)
        //     if (data.status !== "packed") updates.status = "packed";
        //     await updateDoc(doc(db, "orders", id), updates);
        //     alert("Marked as delivered ✅");
        //   } catch (err) {
        //     console.error(err);
        //     alert("Failed to mark as delivered");
        //   }
        // }
        if (btn.dataset.act === "toggleDelivered") {
          const snap = await getDoc(doc(db, "orders", id));
          if (!snap.exists()) return;
          const data = snap.data();

          if (data.deliveryStatus === "delivered" || data.status === "packed") {
            if (!confirm("⚠️ Are you sure you want to undo Delivered?")) return;
            await updateDoc(doc(db, "orders", id), {
              deliveryStatus: "notDelivered",
              status: "packing",
              updatedAt: serverTimestamp(),
            });
            alert("Delivery undone ❌");
          } else {
            const updates = {
              deliveryStatus: "delivered",
              updatedAt: serverTimestamp(),
            };
            if (data.status !== "packed") updates.status = "packed";
            await updateDoc(doc(db, "orders", id), updates);
            alert("Marked as Delivered ✅");
          }
        }
      });

      // Toggle collapse row when clicking customer name
      tbody.addEventListener("click", (e) => {
        if (e.target.classList.contains("collapse-btn")) {
          const details = e.target
            .closest(".name-wrapper")
            .querySelector(".details");
          if (details) {
            details.style.display =
              details.style.display === "none" ? "block" : "none";
            e.target.textContent = e.target.textContent.includes("▼")
              ? e.target.textContent.replace("▼", "▲")
              : e.target.textContent.replace("▲", "▼");
          }
        }
      });

      // ---------- Invoice preview + PDF ----------
      function openInvoicePreview(id, order) {
        // HTML preview for quick look
        previewEl.innerHTML = buildInvoiceHtml(id, order);
        modal.classList.add("show");
        modal.setAttribute("aria-hidden", "false");
      }
      closeModal.addEventListener("click", () => {
        modal.classList.remove("show");
        modal.setAttribute("aria-hidden", "true");
      });
      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal.click();
      });

      downloadBtn.addEventListener("click", () => {
        if (!CURRENT_ORDER) return;
        downloadInvoicePdf(CURRENT_ORDER_ID, CURRENT_ORDER);
      });

      function buildInvoiceHtml(id, o) {
        const date = o.createdAt?.toDate ? o.createdAt.toDate() : new Date();
        const items = (o.items || [])
          .map(
            (it) => `
        <tr>
          <td>${escapeHtml(it.name || "")}</td>
          <td style="text-align:right">${it.qty || 1}</td>
          <td style="text-align:right">₹${formatINR(
            it.price ?? it.sale ?? 0
          )}</td>
          <td style="text-align:right">₹${formatINR(
            (it.price ?? it.sale ?? 0) * (it.qty || 1)
          )}</td>
        </tr>
      `
          )
          .join("");
        const total =
          o.amount ??
          o.total ??
          (o.items || []).reduce(
            (s, it) => s + (it.qty || 1) * (it.price ?? it.sale ?? 0),
            0
          );

        return `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div>
            <div style="font-size:20px;font-weight:700">ABS Crackers World</div>
            <div style="font-size:12px;color:#334155">Retail Invoice</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:12px;color:#334155">Invoice No</div>
            <div style="font-weight:700">INV-${id
              .slice(0, 6)
              .toUpperCase()}</div>
          </div>
        </div>

        <div class="inv-row">
          <div class="inv-col">
            <div class="inv-k">Billed To</div>
            <div class="inv-v" style="margin-top:2px">${escapeHtml(
              o.name || ""
            )}</div>
            <div>${escapeHtml(o.phone || "")}</div>
            <div style="white-space:pre-wrap">${escapeHtml(
              o.address || ""
            )}</div>
          </div>
          <div class="inv-col">
            <div class="inv-k">Invoice Date</div>
            <div class="inv-v" style="margin-top:2px">${new Date(
              date
            ).toLocaleString("en-IN")}</div>
            <div class="inv-k" style="margin-top:8px">Company</div>
            <div>ABS Crackers World</div>
          </div>
        </div>

        <table class="inv-table">
          <thead><tr>
            <th>Item</th><th style="text-align:right">Qty</th>
            <th style="text-align:right">Price</th><th style="text-align:right">Total</th>
          </tr></thead>
          <tbody>${items}</tbody>
        </table>

        <div class="inv-total">Grand Total: ₹${formatINR(total)}</div>

        <div style="margin-top:10px;font-size:12px;color:#475569">Thanks for your business!</div>
      `;
      }

      function downloadInvoicePdf(id, o) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // --- Load ABS Logo --- (if images fail it's okay)
        const logo = new Image();
        logo.crossOrigin = "anonymous";
        logo.src = "https://i.postimg.cc/9Fj7rpxZ/abs-logo.jpg";

        const godImg = new Image();
        godImg.crossOrigin = "anonymous";
        godImg.src = "https://i.postimg.cc/MGmbtLv7/abs-god.webp";

        Promise.all([
          new Promise((res) => {
            logo.onload = res;
            logo.onerror = res;
          }),
          new Promise((res) => {
            godImg.onload = res;
            godImg.onerror = res;
          }),
        ]).then(() => {
          try {
            doc.addImage(logo, "JPEG", 14, 10, 30, 30);
          } catch (e) {}
          try {
            doc.addImage(godImg, "WEBP", 165, 10, 30, 30);
          } catch (e) {}

          doc.setFontSize(16);
          doc.text("ABS Crackers World", 60, 20);
          doc.setFontSize(10);
          doc.text("5/288/33, Sivakasi - 626189", 60, 26);
          doc.text("Contact: +91 80720 98251 / 95971 89599", 60, 32);

          const invoiceNo = "INV-" + id.slice(0, 6).toUpperCase();
          const date = o.createdAt?.toDate ? o.createdAt.toDate() : new Date();
          doc.setFontSize(11);
          doc.text(`Invoice No: ${invoiceNo}`, 150, 48);
          doc.text(`Date: ${new Date(date).toLocaleDateString()}`, 150, 54);

          doc.setFontSize(12);
          doc.text("Bill To:", 14, 50);
          doc.text(o.name || "N/A", 50, 50);
          doc.text("Mobile:", 14, 56);
          doc.text(o.phone || "N/A", 50, 56);
          doc.text("Ship To:", 14, 66);
          doc.text((o.address || "").replace(/\r?\n/g, ", "), 50, 66);

          const rows = [];
          let idx = 1,
            subtotal = 0;
          for (const it of o.items || []) {
            const qty = it.qty || 1;
            const price = it.price ?? it.sale ?? 0;
            const lineTotal = price * qty;
            subtotal += lineTotal;
            rows.push([
              idx++,
              it.name,
              qty,
              "Rs. " + (price || 0).toLocaleString("en-IN"),
              "Rs. " + lineTotal.toLocaleString("en-IN"),
            ]);
          }

          doc.autoTable({
            head: [["#", "Product", "Qty", "Price", "Total"]],
            body: rows,
            startY: 80,
            theme: "striped",
            headStyles: { fillColor: [0, 123, 255] },
            styles: { halign: "center" },
            columnStyles: {
              1: { halign: "left" },
              2: { halign: "center" },
              3: { halign: "right" },
              4: { halign: "right" },
            },
          });

          const finalY = doc.lastAutoTable.finalY + 10;
          doc.setFontSize(14);
          doc.setLineWidth(0.5);
          doc.line(150, finalY - 4, 200, finalY - 4);
          doc.text(
            `Total: Rs. ${subtotal.toLocaleString("en-IN")}`,
            200,
            finalY + 4,
            { align: "right" }
          );
          doc.setFontSize(12);
          doc.text("Thank you for your order!", 80, 290);
          doc.save(`Invoice_${invoiceNo}.pdf`);
        });
      }

      // ---------- Package checklist logic ----------
      function openPackageChecklist(id, order) {
        const items = order.items || [];
        const packedArr =
          (order.packing && order.packing.packedQty) || items.map(() => 0);
        const total = items.reduce((s, it) => s + (it.qty || 1), 0);

        packageChecklistEl.innerHTML = `
          <div class="package-summary">
            <div><strong>Order:</strong> INV-${id
              .slice(0, 6)
              .toUpperCase()} • <small>${escapeHtml(
          order.name || ""
        )}</small></div>
            <div id="packProgress">0 / ${total} packed</div>
          </div>

          <div style="overflow:auto;max-height:56vh">
            <table class="inv-table">
              <thead>
                <tr><th>Item</th><th style="text-align:right">Qty</th><th style="text-align:right">Packed Qty</th><th style="text-align:center">Done</th></tr>
              </thead>
              <tbody>
                ${items
                  .map((it, idx) => {
                    const packed = packedArr[idx] || 0;
                    return `
                    <tr>
                      <td>${escapeHtml(it.name || "")}</td>
                      <td style="text-align:right">${it.qty || 1}</td>
                      <td style="text-align:right">
                        <input class="packed-qty-input" type="number" min="0" max="${
                          it.qty || 1
                        }" value="${packed}" data-idx="${idx}">
                      </td>
                      <td style="text-align:center">
                        <input type="checkbox" data-idx="${idx}" ${
                      packed >= (it.qty || 1) ? "checked" : ""
                    }>
                      </td>
                    </tr>
                  `;
                  })
                  .join("")}
              </tbody>
            </table>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="savePackingBtn" class="btn btn-primary btn-xs">Save Progress</button>
            <button id="markPackedBtn" class="btn btn-primary btn-xs">Mark as Packed</button>
            <button id="closePackageBtnInline" class="btn btn-xs">Close</button>
          </div>
        `;

        packageModal.classList.add("show");
        packageModal.setAttribute("aria-hidden", "false");

        // attach listeners inside modal
        attachPackageListeners();
        updatePackProgress();
      }

      function attachPackageListeners() {
        // Save / Mark / Inline close
        const saveBtn = packageChecklistEl.querySelector("#savePackingBtn");
        const markBtn = packageChecklistEl.querySelector("#markPackedBtn");
        const inlineClose = packageChecklistEl.querySelector(
          "#closePackageBtnInline"
        );

        if (saveBtn)
          saveBtn.addEventListener("click", () => savePackingProgress(false));
        if (markBtn)
          markBtn.addEventListener("click", () => savePackingProgress(true));
        if (inlineClose)
          inlineClose.addEventListener("click", () => closePackageModal());

        // Input sync (qty <-> checkbox)
        packageChecklistEl.addEventListener("input", (e) => {
          if (
            e.target.classList &&
            e.target.classList.contains("packed-qty-input")
          ) {
            const idx = e.target.dataset.idx;
            const max = Number(e.target.max) || 1;
            let val = Number(e.target.value) || 0;
            if (val > max) {
              e.target.value = max;
              val = max;
            }
            const cb = packageChecklistEl.querySelector(
              `input[type="checkbox"][data-idx="${idx}"]`
            );
            if (cb) cb.checked = val >= max;
            updatePackProgress();
          }
        });

        packageChecklistEl.addEventListener("change", (e) => {
          if (e.target.type === "checkbox") {
            const idx = e.target.dataset.idx;
            const qtyInput = packageChecklistEl.querySelector(
              `.packed-qty-input[data-idx="${idx}"]`
            );
            const max = Number(qtyInput?.max) || 1;
            if (e.target.checked) qtyInput.value = max;
            else qtyInput.value = 0;
            updatePackProgress();
          }
        });
      }

      function updatePackProgress() {
        const inputs = packageChecklistEl.querySelectorAll(".packed-qty-input");
        let packed = 0,
          total = 0;
        inputs.forEach((inp) => {
          const max = Number(inp.max) || 1;
          const val = Math.min(Number(inp.value) || 0, max);
          total += max;
          packed += val;
        });
        const progEl = packageChecklistEl.querySelector("#packProgress");
        if (progEl) progEl.textContent = `${packed} / ${total} packed`;
      }

      async function savePackingProgress(markPacked = false) {
        if (!CURRENT_ORDER_ID) return;
        const items = CURRENT_ORDER.items || [];
        const packedQty = items.map((it, idx) => {
          const inp = packageChecklistEl.querySelector(
            `.packed-qty-input[data-idx="${idx}"]`
          );
          const val = Math.max(
            0,
            Math.min(Number(inp?.value) || 0, it.qty || 1)
          );
          return val;
        });

        const packedCount = packedQty.reduce((a, b) => a + b, 0);
        const inferredStatus = packedQty.every(
          (q, idx) => q >= (items[idx].qty || 1)
        )
          ? "packed"
          : "packing";
        const status = markPacked ? "packed" : inferredStatus;

        const packingObj = {
          packedQty,
          packedCount,
          status,
          updatedAt: serverTimestamp(),
          updatedBy: auth.currentUser?.email || null,
        };

        await updateDoc(doc(db, "orders", CURRENT_ORDER_ID), {
          packing: packingObj,
          status,
        });
        alert(
          markPacked ? "Order marked as packed ✅" : "Packing progress saved"
        );
        closePackageModal();
      }

      function closePackageModal() {
        packageModal.classList.remove("show");
        packageModal.setAttribute("aria-hidden", "true");
        packageChecklistEl.innerHTML = "";
      }

      // top-right close button
      closePackageModalBtn?.addEventListener("click", closePackageModal);
      packageModal?.addEventListener("click", (e) => {
        if (e.target === packageModal) closePackageModal();
      });

      // ---------- helpers ----------
      function formatINR(n) {
        const num = Number(n || 0);
        return num.toLocaleString("en-IN");
      }
      function escapeHtml(s = "") {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
    </script>
  </body>
</html>
